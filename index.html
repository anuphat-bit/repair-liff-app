<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- ใช้ LIFF ID ที่ถูกต้องของคุณ ---
    liff.init({ liffId: "2008248434-1k7bSQPa" })
        .then(() => {
            // ตรวจสอบว่าล็อกอินหรือยัง
            if (!liff.isLoggedIn()) {
                // ถ้ายังไม่ล็อกอิน ให้โยน Error ไปที่ .catch เพื่อหยุดการทำงานทันที
                throw new Error("ไม่ได้ล็อกอินใน LIFF กรุณาเปิดจากแอป LINE");
            }
            // ถ้าล็อกอินแล้ว ให้ไปขอข้อมูลโปรไฟล์ต่อ
            return liff.getProfile();
        })
        .then(profile => {
            // ฟังก์ชันนี้จะทำงานก็ต่อเมื่อ getProfile สำเร็จเท่านั้น
            document.getElementById('lineUserId').value = profile.userId;
            document.getElementById('requesterName').value = profile.displayName;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('repair-form').style.display = 'block';
        })
        .catch((err) => {
            // ดักจับ Error ทั้งหมดที่เกิดขึ้นใน .then ด้านบน
            console.error(err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').innerText = 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message;
            document.getElementById('error-message').style.display = 'block';
        });

    // --- โค้ดส่วน Form Submission (เหมือนเดิม) ---
    const form = document.getElementById('repair-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = true;
        submitButton.innerText = 'กำลังส่ง...';
        const file = document.getElementById('problemImage').files[0];
        const formObject = Object.fromEntries(new FormData(this).entries());
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                formObject.fileData = {
                    fileName: file.name, mimeType: file.type,
                    base64: e.target.result.split(',')[1]
                };
                google.script.run.withSuccessHandler(showSuccess).withFailureHandler(showError).submitForm(formObject);
            };
            reader.readAsDataURL(file);
        } else {
            google.script.run.withSuccessHandler(showSuccess).withFailureHandler(showError).submitForm(formObject);
        }
    });
});

function showSuccess(response) {
    if (response.status === "success") {
        document.getElementById('repair-form').style.display = 'none';
        const modal = document.getElementById('success-modal');
        document.querySelectorAll('.ticket-id-display').forEach(el => { el.innerText = response.ticketId; });
        modal.style.display = 'flex';
        setTimeout(() => { liff.closeWindow(); }, 6000);
    } else { showError({ message: response.message }); }
}
function showError(error) {
    alert('เกิดข้อผิดพลาด: ' + error.message);
    const submitButton = document.getElementById('submit-button');
    submitButton.disabled = false;
    submitButton.innerText = 'ส่งเรื่อง';
}
</script>
